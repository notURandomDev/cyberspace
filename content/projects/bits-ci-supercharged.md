# Bits CI SuperCharged

这个项目是我在字节跳动实习的头一个月，花空余时间写出来的工具网站；主要的目的是：

- 提升我迁移 CI 任务的效率
- 一直想用 HeroUI 写一个网站，因为觉得这个 UI 库很精美

有了这两个基本的驱动来源之后，这个项目很快就初现雏形了。

![IMG_6832.jpeg](attachment:6b06da10-d78d-423e-9179-09204fb77a8d:0c47975e-dab4-4393-b35f-29795104a4c8.png)

接下来，我会根据后续工作中的实际任务需求，继续完善这个项目；提升我的工作效率。

## 为什么我需要这个工具网站？

### 我的工作

在字节实习的头一个月，我们组的主要任务是将飞书各端的代码仓库迁移到一个 Monorepo 中；而我的主要任务，则是负责原 Android 端代码空间中 CI 任务的迁移工作。

尽管公司有自己的代码托管平台，平台 GUI 也覆盖了大部分对于 CI 任务的各种操作接口。但是，由于我需要通过改动分支代码来测试 CI 任务的触发情况，一旦将本地的 commit push 到远程之后，MR 的 CI 任务就会被重新触发。

考虑到某些任务的执行时间比较久（特别是构建类任务），我通常会开 2-3 个 MR，并发进行多个任务的迁移工作，以防止在测试 A 任务的检测情况时，在同分支上 push 了用于测试 B 任务的代码；导致 A 任务构建一半就被终止了。

### troubles

在这种快速工作的方式下，我发现有时候我只需要测试一个任务，但是 workflow 中的所有任务都被一同触发了。虽然这样无伤大雅，但是我认为有两个原因，可以优化这个流程：

- 每次任务构建成功之后，飞书的机器人就会给我发通知；这个通知我也不应该关掉，因为在工作中一些重要的任务构建成功之后，这个通知还是很能保证时效性的。但是在测试过程中，这些通知就比较烦人
- 构建任务其实是挺消耗资源的，而那些不是我测试目标的任务被一同触发构建，是完全没必要的；站在公司整体的角度来想，尽管我占用的服务器资源只是冰山一角，但是这种资源应该留给需要的人

### 代码托管平台的约束

公司的代码托管平台并没有提供一键暂停当前 pipeline 中所有 CI 任务的接口，然而这其实是合理的。因为 pipeline 中的这些任务本来就是为了检查 MR 代码的正确性，不应该被跳过或手动终止。

但是结合我的工作情况，我认为有这么一个 **一键终止pipeline中所有任务** 的功能，对我来说是很有用的。

## 工具的前身

### TypeScript 脚本

其实一开始，一键终止的功能其实是写在一个 ts 脚本里的。我需要做的，仅是在脚本运行前提供 MR 的 ID；接口会返回当前 MR 最新的 pipeline ID，于是脚本就可以自动处理剩余的请求。

但是在过程中，我发现自己经常在不同 MR 的上下文中使用这个脚本；这就需要我频繁地从平台上复制 MR 的 ID，黏贴到脚本中，再运行脚本。

于是我就想，如果有一个界面能够展示所有 MR 信息，这样就能够快速在 MR 之间进行切换；当前选中的 MR 也能存在一个状态里，这样就能够动态地发送请求了！

## 可视化工具

和公司提供的 DevOps 平台中 MR 详情页最大的差距就是，这个网页的功能聚焦于 MR 和 Pipeline 两个实体。其中，Pipeline 为主，MR 为辅；给我提供了快速、批量管理 Pipeline 中任务状态的能力。

这也是为什么，这个网页的名字叫 **Bits CI SuperCharged**。（Bits是字节内部DevOps平台的名称）

### 主要功能

- 任务信息展示
- 单任务操作：对任务进行重试、终止、调试工作
- 批量任务操作：一键对于特定状态的任务进行常用的操作
- MR切换：快速切换、管理不同 MR 中的 Pipeline 任务

## Takeaways

这个工具网页，在多个方面帮助了我：

- 提升工作效率：工具提供的批量请求（一键终止、重试任务），使我不用一个个任务点过去，极大地提升了我的工作效率。
- 熟悉公司内部开放平台的接口：在迁移 CI 任务的时候，需要阅读大量脚本代码，才能溯源到适配点。这其中就包括了很多和 MR、Pipeline 相关的请求。而在打造这个工具的过程中，我对这些接口的调用产生了大量的接触，因此降低了在工作中理解代码的成本（我是初来乍到的实习生）。
- 深度接触了 HeroUI 库：如愿以偿地通过这次机会，使用了 HeroUI 库；其精美程度确实令我很惊艳。对于这个组件库的熟悉，奠定了随后我使用同一个组件库开发个人网站的开发效率。
